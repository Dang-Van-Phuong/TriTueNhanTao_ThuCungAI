<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üê∂ AI Pet Robot ‚Äì Demo</title>

  <!-- üß† Th√™m d√≤ng n√†y ƒë·ªÉ fix l·ªói tf is not defined -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>

  <!-- üß™ Sau ƒë√≥ m·ªõi t·ªõi Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
    .box { border: 1px solid #ddd; padding: 15px; border-radius: 10px; margin-top: 20px; }
    button { padding: 10px 20px; margin-top: 10px; cursor: pointer; }
    #reply {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      min-height: 150px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <h1>üê∂ AI Pet Robot ‚Äì Demo</h1>

  <!-- CAMERA -->
  <div class="box">
    <h3>üé• Camera & Nh·∫≠n di·ªán c·∫£m x√∫c</h3>
    <div id="webcam" style="width: 300px; height: 300px;"></div>
    <p>C·∫£m x√∫c: <span id="emotion">‚Äì</span></p>
    <button id="startBtn">B·∫Øt ƒë·∫ßu</button>
    <button id="stopBtn" disabled>D·ª´ng</button>
  </div>

  <!-- GEMINI CHAT -->
  <div class="box">
    <h3>üí¨ Tr√≤ chuy·ªán v·ªõi Gemini</h3>
    <textarea id="userText" rows="3" style="width:100%" placeholder="Nh·∫≠p l·ªùi b·∫°n mu·ªën n√≥i..."></textarea>
    <br>
    <button id="chatBtn">G·ª≠i</button>
    <div id="reply"></div>
  </div>

  <script>
    // ===== CONFIG =====
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/kCPi9VYRV/"; // Thay b·∫±ng link th·∫≠t (c√≥ d·∫•u / ·ªü cu·ªëi)
    const GEMINI_API_KEY = "AIzaSyCXIeDJwtEVFxqo26ht8PRmKhiLIVn3tmw"; // Thay b·∫±ng API KEY c·ªßa b·∫°n

    let model, webcam, maxPredictions, loopId;

    async function initModel() {
      const modelURL = MODEL_URL + "model.json";
      const metadataURL = MODEL_URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();
    }

    async function getExternalCameraId() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(device => device.kind === "videoinput");
      if (videoDevices.length === 0) throw new Error("Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã camera n√†o.");
      const usbCam = videoDevices.find(cam => cam.label.toLowerCase().includes("usb"));
      return (usbCam || videoDevices[0]).deviceId;
    }

    async function startCam() {
      const flip = true;
      const deviceId = await getExternalCameraId();
      webcam = new tmImage.Webcam(300, 300, flip);
      try {
        await webcam.setup({ deviceId });
        await webcam.play();
        console.log("üé• ƒêang d√πng camera:", deviceId);
        document.getElementById("webcam").innerHTML = '';
        document.getElementById("webcam").appendChild(webcam.canvas);
        loopId = window.requestAnimationFrame(loop);
      } catch (err) {
        alert("Kh√¥ng th·ªÉ b·∫≠t camera: " + err.message);
        console.error("‚ùå L·ªói camera:", err);
      }
    }

    async function loop() {
      webcam.update();
      await predict();
      loopId = window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      let best = prediction.reduce((a, b) => a.probability > b.probability ? a : b);
      document.getElementById("emotion").innerText = `${best.className.toUpperCase()} (${(best.probability * 100).toFixed(1)}%)`;
    }

    // ==== Chat Function ====
    const chatBox = document.getElementById("reply");
    const inputBox = document.getElementById("userText");

    async function sendMessage() {
      const text = inputBox.value.trim();
      if (text === "") return;

      // Hi·ªÉn th·ªã ng∆∞·ªùi d√πng
      const userMsg = document.createElement("div");
      userMsg.style.marginBottom = "10px";
      userMsg.innerHTML = `<strong>B·∫°n:</strong> ${text}`;
      chatBox.appendChild(userMsg);

      inputBox.value = ""; // xo√° n·ªôi dung

      const emotion = document.getElementById("emotion").innerText;
      const prompt = `B·∫°n l√† th√∫ c∆∞ng d·ªÖ th∆∞∆°ng. H·ªçc sinh c√≥ c·∫£m x√∫c: ${emotion}. H·ªçc sinh n√≥i: "${text}". H√£y tr·∫£ l·ªùi ng·∫Øn g·ªçn (‚â§3 c√¢u), an to√†n v√† d·ªÖ th∆∞∆°ng.`;

      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });

      const data = await res.json();
      const replyText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Kh√¥ng c√≥ ph·∫£n h·ªìi.";

      // Hi·ªÉn th·ªã ph·∫£n h·ªìi
      const botMsg = document.createElement("div");
      botMsg.style.marginBottom = "15px";
      botMsg.innerHTML = `<strong>üê∂ PetBot:</strong> ${replyText}`;
      chatBox.appendChild(botMsg);

      // ƒê·ªçc to
      const synth = window.speechSynthesis;
      synth.speak(new SpeechSynthesisUtterance(replyText));

      // Cu·ªôn xu·ªëng
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ==== S·ª± ki·ªán ====
    document.getElementById("chatBtn").addEventListener("click", sendMessage);

    inputBox.addEventListener("keydown", async (event) => {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        await sendMessage();
      }
    });

    document.getElementById("startBtn").addEventListener("click", async () => {
      await initModel();
      await startCam();
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
    });

    document.getElementById("stopBtn").addEventListener("click", () => {
      cancelAnimationFrame(loopId);
      webcam.stop();
      document.getElementById("startBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;
    });
  </script>
</body>
</html>
