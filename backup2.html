<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üê∂ AI Pet Robot ‚Äì Demo (Arena Center)</title>

  <!-- LIBS -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- THEME & UI -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
    :root{
      --bg1:#e0f7fa; --bg2:#f1f8ff; --text:#0f172a; --muted:#64748b;
      --border:#d0e0f0; --card:#ffffffcc; --accent:#06b6d4; --accent2:#10b981;
      --arena-h:56vh; --arena-min:360px; --track-w:min(92vw,1100px); --pet-w:320px;
    }
    *{box-sizing:border-box;transition:all .25s ease}
    body{font-family:'Poppins',sans-serif;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh;overflow-x:hidden}

    /* POPUP chung */
    #userInfoOverlay, #endConfirmOverlay{
      position:fixed; inset:0; background:rgba(255,255,255,0.9);
      display:flex; align-items:center; justify-content:center; z-index:9999;
    }
    #endConfirmOverlay{ display:none; z-index:10000; }
    .popup-box{
      background:#fff; border-radius:16px; padding:28px 32px; max-width:380px; width:90%;
      box-shadow:0 8px 24px rgba(0,0,0,0.15); text-align:center; animation:fadeIn .3s ease;
    }
    .popup-box h2{ color:var(--accent); margin:0 0 8px }
    .popup-box label{ display:block; text-align:left; margin-top:10px; font-weight:500; color:var(--muted) }
    .popup-box input{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border); margin-top:4px; font-size:14px }
    .popup-box input:focus{ border-color:var(--accent); outline:none }
    .popup-box button{ margin-top:14px }
    @keyframes fadeIn{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}

    /* HEADER */
    header{text-align:center;padding:24px 16px 10px}
    h1{font-size:clamp(26px,3vw,34px);margin:0;background:linear-gradient(90deg,#06b6d4,#10b981);-webkit-background-clip:text;color:transparent;font-weight:600;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:15px;margin-top:6px}

    /* ARENA */
    .arena{width:100%;display:flex;align-items:center;justify-content:center;height:var(--arena-h);min-height:var(--arena-min);background:radial-gradient(circle at center,#d7fafa 0%,#e8f7ff 80%);border-top:2px solid #b3ecf5;border-bottom:2px solid #b3ecf5;box-shadow:inset 0 0 20px #c8f1ff}
    .track{width:var(--track-w);height:100%;position:relative;margin:0 auto;overflow:hidden}
    .pet-walk{position:absolute;bottom:0;left:0;width:var(--pet-w);will-change:transform;animation:patrol 14s ease-in-out infinite;transform-origin:center bottom;pointer-events:none}
    @keyframes patrol{
      0%{transform:translateX(0) scaleX(1);}
      50%{transform:translateX(calc(var(--track-w) - var(--pet-w))) scaleX(1);}
      51%{transform:translateX(calc(var(--track-w) - var(--pet-w))) scaleX(-1);}
      100%{transform:translateX(0) scaleX(-1);}
    }
    model-viewer.pet{width:100%;height:min(54vh,420px);background:transparent;--poster-color:transparent;filter:drop-shadow(0 0 20px rgba(0,255,255,.3));border:none}

    /* GRID */
    .container{max-width:1100px;margin:24px auto 50px;padding:0 16px}
    .grid{display:grid;gap:24px;grid-template-columns:1fr 1fr}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}

    .box{background:var(--card);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:18px;padding:20px 22px;box-shadow:0 8px 18px rgba(0,0,0,0.08);position:relative}
    .box h3{margin:0 0 14px;color:var(--accent);font-weight:600;text-align:center;font-size:18px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center}

    select,button,textarea{font-family:'Poppins',sans-serif;font-size:14px}
    select{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    button{padding:10px 18px;border-radius:12px;border:1px solid var(--border);background:#e6faff;cursor:pointer;font-weight:500;color:#03696b}
    button:hover{background:var(--accent);color:#fff;box-shadow:0 0 8px rgba(0,180,200,.4)}
    button.primary{background:var(--accent2);border-color:var(--accent2);color:#fff}
    button.primary:hover{background:#0ea36e;box-shadow:0 0 10px rgba(16,185,129,.4)}
    button:disabled{opacity:.6;cursor:not-allowed}

    /* CAMERA */
    #webcam{width:100%;max-width:300px;aspect-ratio:1/1;border-radius:14px;overflow:hidden;border:2px dashed var(--border);background:#f8fafc;display:flex;align-items:center;justify-content:center;margin:auto}
    #rawVideoWrap video{border-radius:10px;box-shadow:0 0 8px rgba(0,0,0,0.15)}
    #emotionBar{display:flex;gap:8px;align-items:center;font-weight:600;justify-content:center;margin-top:4px}
    #emotion{padding:4px 10px;border-radius:10px;background:#ccfbf1;border:1px solid #99f6e4;color:#047857}
    #diag{text-align:center;margin:6px 0 0}

    /* CHAT */
    #userText{width:100%;min-height:96px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);resize:vertical;background:#fff}
    #userText:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 3px #a5f3fc}
    #reply{padding:14px;background:#f8fafc;border:1px solid var(--border);border-radius:12px;min-height:150px;max-height:360px;overflow:auto;margin-top:12px}
    .msg{margin:8px 0;background:#fff;padding:8px 10px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
    .msg b{color:var(--accent2)}
  </style>
</head>

<body>
  <!-- HEADER -->
  <header>
    <h1>üê∂ AI Pet Robot ‚Äì Demo</h1>
    <p class="sub">S√¢n ch∆°i ·ªü gi·ªØa; Chat & Camera chuy·ªÉn xu·ªëng b√™n d∆∞·ªõi.</p>
  </header>

  <!-- ARENA -->
  <section class="arena" aria-label="Khu v·ª±c th√∫ c∆∞ng AI">
    <div class="track" id="track">
      <div class="pet-walk" id="petWalk">
        <model-viewer id="pet3d" class="pet" src="wuup.glb"></model-viewer>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <div class="container">
    <div class="grid">
      <!-- Camera -->
      <section class="box" aria-labelledby="cam-title">
        <h3 id="cam-title">üé• Camera & Nh·∫≠n di·ªán c·∫£m x√∫c</h3>
        <div class="row" style="gap:8px">
          <select id="camSelect" style="min-width:240px"></select>
          <button id="refreshBtn" title="Qu√©t l·∫°i camera">Qu√©t camera</button>
          <label style="display:flex;align-items:center;gap:6px;font-size:14px">
            <input type="checkbox" id="debugToggle"> Debug video
          </label>
        </div>

        <div id="webcamWrap" style="display:flex;flex-direction:column;gap:10px">
          <div id="webcam"><span class="hint">Video 1:1 s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y sau khi b·∫≠t camera</span></div>
          <div id="rawVideoWrap" style="display:none; text-align:center">
            <video id="rawVideo" autoplay playsinline muted style="max-width:300px;border-radius:10px;border:1px solid var(--border)"></video>
            <div class="hint">Xem tr·ª±c ti·∫øp lu·ªìng camera (debug)</div>
          </div>
          <div id="emotionBar">C·∫£m x√∫c: <span id="emotion">‚Äì</span></div>
          <p id="diag" class="hint">‚è≥ Ch∆∞a kh·ªüi ƒë·ªông.</p>
          <div class="row">
            <button id="startBtn" class="primary">B·∫Øt ƒë·∫ßu</button>
            <button id="stopBtn" disabled>D·ª´ng</button>
          </div>
          <p class="hint" style="text-align:center">
            Y√™u c·∫ßu ch·∫°y tr√™n HTTPS ho·∫∑c <code>http://localhost</code> ƒë·ªÉ truy c·∫≠p camera.
          </p>
        </div>
      </section>

      <!-- Chat -->
      <section class="box" aria-labelledby="chat-title">
        <h3 id="chat-title">üí¨ Tr√≤ chuy·ªán v·ªõi Gemini</h3>
        <textarea id="userText" placeholder="Nh·∫≠p l·ªùi b·∫°n mu·ªën n√≥i..."></textarea>
        <div class="row">
          <button id="chatBtn" class="primary">G·ª≠i</button>
          <button id="clearBtn" title="Xo√° khung chat">Xo√°</button>
          <button id="endBtn" title="K·∫øt th√∫c phi√™n">K·∫øt th√∫c</button>
        </div>
        <div id="reply" aria-live="polite" aria-busy="false"></div>
        <p class="hint">
          L∆∞u √Ω: Kh√¥ng n√™n nh√∫ng API key tr·ª±c ti·∫øp tr√™n client trong m√¥i tr∆∞·ªùng th·∫≠t; h√£y d√πng proxy/backend.
        </p>
      </section>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    /* ========= 6.1 CONFIG ========= */
    // ƒê·ªïi ƒë∆∞·ªùng d·∫´n n√†y n·∫øu th∆∞ m·ª•c model c·ªßa b·∫°n t√™n kh√°c.
    const MODEL_URL = "./NhanDienCamXuc/";  // v√≠ d·ª•: ./model/
    const GEMINI_API_KEY = "PASTE_YOUR_GEMINI_API_KEY_HERE";
    const MODEL_NAME = "gemini-2.5-flash";

    /* ========= 6.2 GLOBALS ========= */
    let model, webcam, maxPredictions, loopId, isRunning = false;
    let ended = false; // tr·∫°ng th√°i k·∫øt th√∫c phi√™n
    function $(id){ return document.getElementById(id); }

    /* ========= 6.3 USER INFO (session) ========= */
    function getUserInfoSession(){
      try{ const r = sessionStorage.getItem("userInfo"); return r ? JSON.parse(r) : null; }catch{ return null; }
    }
    function setUserInfoSession(info){ sessionStorage.setItem("userInfo", JSON.stringify(info)); }

    /* ========= 6.4 LOAD TM IMAGE MODEL ========= */
    async function initModel() {
      const base = MODEL_URL.replace(/\/?$/, "/");
      const modelURL = base + "model.json";
      const metadataURL = base + "metadata.json";
      $("diag").innerText = "‚¨áÔ∏è ƒêang t·∫£i model...";
      try {
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();
        $("diag").innerText = `‚úÖ Model ƒë√£ s·∫µn s√†ng (${maxPredictions} l·ªõp)`;
      } catch (e) {
        console.error("‚ùå L·ªói load model:", e);
        $("diag").innerText = "‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c model. Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n MODEL_URL.";
      }
    }

    /* ========= 6.5 CAMERA ========= */
    async function ensurePermissionOnce(){ await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); }

    async function listCameras() {
      const sel = $("camSelect"); sel.innerHTML = "";
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === "videoinput");
      if (!cams.length) { alert("Kh√¥ng t√¨m th·∫•y camera."); return; }
      cams.sort((a,b)=>((a.label||"").toLowerCase().includes("usb")? -1:0) - ((b.label||"").toLowerCase().includes("usb")? -1:0));
      cams.forEach((c,i)=>{ const opt=document.createElement("option"); opt.value=c.deviceId; opt.textContent=c.label||`Camera ${i+1}`; sel.appendChild(opt); });
    }

    function stopCam(keepDropdown=false) {
      if (loopId) cancelAnimationFrame(loopId); loopId=null;
      if (webcam) { try{webcam.stop();}catch{} webcam=null; }
      isRunning=false;
      if (!keepDropdown){ $("startBtn").disabled=false; $("stopBtn").disabled=true; }
      const v=$("rawVideo"); if(v){ v.pause?.(); v.srcObject=null; }
      $("diag").innerText = "‚èπÔ∏è ƒê√£ d·ª´ng camera.";
    }

    async function startCam() {
      stopCam(true);
      $("diag").innerText = "üé• Xin quy·ªÅn camera...";
      await ensurePermissionOnce();
      if (!$("camSelect").options.length) await listCameras();
      const deviceId = $("camSelect").value, flip = true;
      const constraints = { deviceId:{ exact: deviceId }, width:{ ideal:1280 }, height:{ ideal:720 } };
      webcam = new tmImage.Webcam(300,300,flip);
      try{ await webcam.setup(constraints); }
      catch(e){ console.warn("setup(exact) l·ªói, fallback facingMode=user:", e.name);
        await webcam.setup({ facingMode:"user", width:{ideal:1280}, height:{ideal:720} });
      }
      try{ await webcam.play(); } catch(e){ $("diag").innerText="‚ùå Kh√¥ng th·ªÉ ph√°t camera."; throw e; }
      isRunning = true;
      const wrap=$("webcam"); wrap.innerHTML=""; wrap.appendChild(webcam.canvas);
      $("diag").innerText = "üü¢ Camera OK ‚Äì ƒëang d·ª± ƒëo√°n...";
      const showDebug = $("debugToggle").checked;
      $("rawVideoWrap").style.display = showDebug ? "block" : "none";
      if (showDebug) $("rawVideo").srcObject = webcam.webcam.srcObject;
      loopId = requestAnimationFrame(loop);
    }

    async function loop() {
      if (!isRunning) return;
      webcam.update();
      await predict();
      loopId = requestAnimationFrame(loop);
    }

    /* ========= 6.6 EMOTION MAP & PREDICT ========= */
    const EMO_MAP = {
      HAPPY:["HAPPY","JOY","VUI"], SAD:["SAD","BUON","BU·ªíN"],
      ANGRY:["ANGRY","GI·∫¨N","GIAN","T·ª®C","TUC"], SURPRISED:["SURPRISED","SURPRISE","NG·∫†C_NHI√äN","NGAC_NHIEN"],
      NEUTRAL:["NEUTRAL","BT","B√åNH TH∆Ø·ªúNG","BINH THUONG","BINH_THUONG","NORMAL"]
    };
    function pickKeyFromLabel(labelUpper){ for(const k in EMO_MAP){ if(EMO_MAP[k].some(x=>labelUpper.includes(x))) return k; } return "NEUTRAL"; }
    function updateAnimationByEmotion(keyOrText){
      const key=(keyOrText||"").toString().toUpperCase(); const pet3d=$("pet3d");
      const setPet=(n)=>pet3d?.setAttribute("animation-name", n);
      switch(key){ case"HAPPY":setPet('Happy');break; case"SAD":setPet('Sad');break;
        case"ANGRY":setPet('Angry');break; case"SURPRISED":setPet('Surprised');break; default:setPet('Idle'); }
    }
    async function predict() {
      if (!model || !webcam) return;
      try{
        const prediction = await model.predict(webcam.canvas);
        if (!Array.isArray(prediction) || !prediction.length){ $("diag").innerText="‚ö†Ô∏è Model kh√¥ng tr·∫£ k·∫øt qu·∫£."; return; }
        const best = prediction.reduce((a,b)=> a.probability>b.probability?a:b);
        const rawName = (best.className||"").toString();
        const labelUpper = rawName.trim().toUpperCase();
        $("emotion").innerText = `${rawName} ${(best.probability*100).toFixed(1)}%`;
        updateAnimationByEmotion(pickKeyFromLabel(labelUpper));
      }catch(e){ console.error("‚ùå predict error:", e); $("diag").innerText="‚ùå L·ªói d·ª± ƒëo√°n."; }
    }

    /* ========= 6.7 CHAT (Gemini) ========= */
    const chatBox = $("reply"), inputBox = $("userText"), chatBtn = $("chatBtn");
    function appendMsg(role,text){ const div=document.createElement("div"); div.className="msg"; div.innerHTML=`<b>${role}:</b> ${text}`; chatBox.appendChild(div); chatBox.scrollTop=chatBox.scrollHeight; }

    async function sendMessage() {
      // ch·∫∑n n·∫øu ƒë√£ k·∫øt th√∫c phi√™n
      if (ended){ appendMsg("üê∂ PetBot","Phi√™n ƒë√£ k·∫øt th√∫c. T·∫£i l·∫°i trang ƒë·ªÉ b·∫Øt ƒë·∫ßu phi√™n m·ªõi nh√©!"); return; }
      // ch·∫∑n n·∫øu ch∆∞a nh·∫≠p info
      const info = getUserInfoSession();
      if(!info){ $("userInfoOverlay").style.display="flex"; alert("Vui l√≤ng nh·∫≠p H·ªç t√™n, L·ªõp, Tr∆∞·ªùng tr∆∞·ªõc khi tr√≤ chuy·ªán nh√©!"); return; }

      const text = inputBox.value.trim(); if(!text) return;
      appendMsg("B·∫°n", text); inputBox.value="";
      chatBtn.disabled = true; chatBox.setAttribute('aria-busy','true');

      const camEmotion = $("emotion").innerText || "‚Äì";
      const prompt = `B·∫°n l√† th√∫ c∆∞ng d·ªÖ th∆∞∆°ng (PetBot). Th√¥ng tin ng∆∞·ªùi d√πng: H·ªç t√™n: ${info.name}; L·ªõp: ${info.cls}; Tr∆∞·ªùng: ${info.school}. C·∫£m x√∫c t·ª´ khu√¥n m·∫∑t: ${camEmotion}. L·ªùi h·ªçc sinh: "${text}". H√£y tr·∫£ l·ªùi ng·∫Øn g·ªçn (‚â§3 c√¢u), an to√†n, th√¢n thi·ªán, x∆∞ng h√¥ theo t√™n.`;

      const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort(),20000);
      try{
        const url=`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`;
        const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:prompt}]}]}),signal:ctrl.signal});
        const data=await res.json();
        const replyText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Xin l·ªói, m√¨nh ch∆∞a nghe r√µ. B·∫°n n√≥i l·∫°i nh√©?";
        appendMsg("üê∂ PetBot", replyText);
        const u=new SpeechSynthesisUtterance(replyText); u.lang="vi-VN"; u.rate=1.0; u.pitch=1.0; window.speechSynthesis.speak(u);
      }catch(err){ console.error(err); appendMsg("üê∂ PetBot","C√≥ l·ªói khi g·ªçi Gemini. Ki·ªÉm tra API key ho·∫∑c m·∫°ng."); }
      finally{ clearTimeout(t); chatBtn.disabled=false; chatBox.setAttribute('aria-busy','false'); }
    }

    /* ========= 6.8 UI EVENTS ========= */
    $("chatBtn").addEventListener("click", sendMessage);
    $("clearBtn").addEventListener("click", ()=>{ chatBox.innerHTML=""; });
    $("userText").addEventListener("keydown", async (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); await sendMessage(); }});
    $("refreshBtn").addEventListener("click", async ()=>{ try{ await ensurePermissionOnce(); await listCameras(); }catch(e){ alert(e.message); }});
    $("camSelect").addEventListener("change", async ()=>{ try{ await startCam(); $("startBtn").disabled=true; $("stopBtn").disabled=false; }catch(e){ alert("Kh√¥ng b·∫≠t ƒë∆∞·ª£c camera: "+e.message); }});
    $("debugToggle").addEventListener("change", ()=>{ const on=$("debugToggle").checked; $("rawVideoWrap").style.display=on?"block":"none"; if(on && webcam?.webcam?.srcObject) $("rawVideo").srcObject=webcam.webcam.srcObject; else $("rawVideo").srcObject=null; });
    $("startBtn").addEventListener("click", async ()=>{ try{ if(!model){ await initModel(); } await listCameras(); await startCam(); $("startBtn").disabled=true; $("stopBtn").disabled=false; }catch(e){ console.error(e); alert("Kh√¥ng b·∫≠t ƒë∆∞·ª£c camera: "+e.message); }});
    $("stopBtn").addEventListener("click", ()=>{ stopCam(); });

    // C·∫≠p nh·∫≠t --track-w khi resize
    const trackEl=$("track"); new ResizeObserver(()=>{ document.documentElement.style.setProperty('--track-w', trackEl.clientWidth + 'px'); }).observe(trackEl);

    /* ========= 6.9 POPUP NH·∫¨P TH√îNG TIN (lu√¥n h·ªèi m·ªói l·∫ßn t·∫£i) ========= */
    window.addEventListener("DOMContentLoaded", () => {
      const overlay=$("userInfoOverlay"), saveBtn=$("saveInfoBtn");
      const chatBtn=$("chatBtn"), nameInput=$("fullName"), clsInput=$("className"), schInput=$("schoolName");

      // Lu√¥n m·ªü overlay khi t·∫£i trang
      overlay.style.display="flex"; chatBtn.disabled=true;

      // Prefill t·ª´ localStorage (t√πy ch·ªçn)
      try{ const raw=localStorage.getItem("userInfo"); if(raw){ const info=JSON.parse(raw); nameInput.value=info?.name||""; clsInput.value=info?.cls||""; schInput.value=info?.school||""; } }catch{}

      saveBtn.addEventListener("click", ()=>{
        const name=nameInput.value.trim(), cls=clsInput.value.trim(), school=schInput.value.trim();
        if(!name || !cls || !school){ alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç t√™n, l·ªõp v√† tr∆∞·ªùng!"); return; }
        setUserInfoSession({name,cls,school});                 // l∆∞u theo phi√™n
        localStorage.setItem("userInfo", JSON.stringify({name,cls,school})); // l∆∞u d√†i h·∫°n ƒë·ªÉ prefill
        overlay.style.display="none"; chatBtn.disabled=false;
        appendMsg("üê∂ PetBot", `Xin ch√†o ${name} l·ªõp ${cls} ‚Äì ${school}! M√¨nh r·∫•t vui ƒë∆∞·ª£c tr√≤ chuy·ªán c√πng b·∫°n üíñ`);
        $("reply").scrollIntoView({behavior:"smooth", block:"start"});
      });
    });

    /* ========= 6.10 K·∫æT TH√öC PHI√äN ========= */
    $("endBtn").addEventListener("click", ()=>{ if(ended) return; $("endConfirmOverlay").style.display="flex"; });
    $("endYesBtn").addEventListener("click", ()=>{
      $("endConfirmOverlay").style.display="none";
      ended = true; $("chatBtn").disabled = true; $("userText").disabled = true;
      appendMsg("üê∂ PetBot","Tuy·ªát v·ªùi! M√¨nh s·∫Ω g·ª≠i th√™m nh·ªØng g·ª£i √Ω h·ªØu √≠ch: th·ª≠ h√≠t th·ªü 4-7-8, ghi 3 ƒëi·ªÅu bi·∫øt ∆°n, ng·ªß ƒë·ªß gi·∫•c, v·∫≠n ƒë·ªông nh·∫π 10‚Äì15 ph√∫t. N·∫øu c·∫ßn g·∫∑p chuy√™n gia, h√£y g√µ ‚Äúk·∫øt n·ªëi chuy√™n gia‚Äù.");
    });
    $("endNoBtn").addEventListener("click", ()=>{
      $("endConfirmOverlay").style.display="none";
      ended = true; $("chatBtn").disabled = true; $("userText").disabled = true;
      appendMsg("üê∂ PetBot","C·∫£m ∆°n b·∫°n ƒë√£ tr√≤ chuy·ªán h√¥m nay. Khi s·∫µn s√†ng quay l·∫°i, h√£y t·∫£i l·∫°i trang nh√©.");
    });
  </script>

  <!-- POPUP THU TH·∫¨P TH√îNG TIN -->
  <div id="userInfoOverlay">
    <div class="popup-box">
      <h2>üê∂ Ch√†o b·∫°n!</h2>
      <p>Tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán, vui l√≤ng nh·∫≠p v√†i th√¥ng tin nh√© üí¨</p>
      <label>H·ªç v√† t√™n:</label>
      <input type="text" id="fullName" placeholder="Nh·∫≠p h·ªç t√™n...">
      <label>L·ªõp:</label>
      <input type="text" id="className" placeholder="VD: 6A1, 7B2...">
      <label>Tr∆∞·ªùng:</label>
      <input type="text" id="schoolName" placeholder="Nh·∫≠p t√™n tr∆∞·ªùng...">
      <button id="saveInfoBtn" class="primary">B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán</button>
    </div>
  </div>

  <!-- POPUP X√ÅC NH·∫¨N K·∫æT TH√öC -->
  <div id="endConfirmOverlay">
    <div class="popup-box">
      <h2>üîî K·∫øt th√∫c phi√™n</h2>
      <p>B·∫°n c√≥ mu·ªën nh·∫≠n th√™m nh·ªØng l·ªùi khuy√™n h·ªØu √≠ch t·ª´ chuy√™n gia t√¢m l√Ω ch·ª©?</p>
      <div class="row" style="margin-top:8px">
        <button id="endYesBtn" class="primary">C√≥</button>
        <button id="endNoBtn">Kh√¥ng</button>
      </div>
    </div>
  </div>
</body>
</html>
