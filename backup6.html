<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>S√∫p ‚Äì Giao di·ªán s√°ng / t·ªëi</title>

  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- TensorFlow + Teachable Machine (·∫¢nh & √Çm thanh) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/audio@0.8/dist/teachablemachine-audio.min.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    html, body { width:100%; height:100%; zoom:100%; overflow-x:hidden; transition:background .5s ease; }
    * { box-sizing:border-box; margin:0; padding:0; }

    :root {
      /* üé® MODE S√ÅNG */
      --sky: url('TaiNguyen/BackGroundSang.png');
      --grass: url('TaiNguyen/NenCoSang.png');
      --nav:#CDECFF;
      --shadow1:#A5C2E9;
      --shadow2:#90B0C4;
      --user:#69B9E7;
      --brand:#4B6BAD;
      --page:#FFFFFF;
      --text:#1e293b;
      --panel:#ffffff;
      --border:#dbeafe;
    }

    body.dark {
      /* üåô MODE T·ªêI */
      --sky: url('TaiNguyen/BackGroundToi.png');
      --grass: url('TaiNguyen/NenCoToi.png');
      --nav:#4D50A6;
      --shadow1:#26264F;
      --shadow2:#90B0C4;
      --user:#6F77CC;
      --brand:#4B6BAD;
      --page:#0C0B3E;
      --text:#E6E9FF;
      --panel:#1A1B4D;
      --border:#3D4CA0;
    }

    body {
      font-family:'Poppins',sans-serif;
      color:var(--text);
      background:var(--page);
      display:flex; flex-direction:column;
      min-height:100vh; transition:all .4s ease;
    }

    /* ----- HEADER ----- */
    header{
      height:80px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 60px;
      background:var(--nav);
      border-bottom:1px solid var(--shadow2);
      box-shadow:0 6px 18px var(--shadow1);
      transition:all .4s ease;
    }
    .logo{ font-weight:700; font-size:40px; color:var(--brand); transition:color .4s ease; }
    body.dark .logo{ color:var(--text); }

    nav a{
      margin-left:25px; text-decoration:none; font-weight:600; font-size:20px;
      color:var(--text); padding:6px 14px; border-radius:500px; transition:all .25s ease;
    }
    nav a:hover{ background:var(--shadow1); color:#fff; }
    nav a.active{ background:#fff; color:var(--brand); box-shadow:0 0 0 3px var(--shadow2) inset; }

    /* ----- MAIN + n·ªÅn parallax ----- */
    .main{
      flex:1; display:flex; align-items:flex-end; justify-content:center;
      position:relative; width:100%; height:80%;
      overflow:hidden; padding:40px 80px; transition:background 1s ease;

      background-image: var(--sky), var(--sky);
      background-repeat: repeat-x, repeat-x;
      background-size: 2000px auto, 2000px auto;
      background-position: 0px -150px, 2000px -150px;
      animation: skyLoop 200s linear infinite;
    }
    @keyframes skyLoop{
      from{ background-position: 0px -150px, 2000px -150px; }
      to  { background-position:-2000px -150px, 0px   -150px; }
    }
    .main::after{
      content:""; position:absolute; bottom:0; left:0; right:0;
      width:75%; height:95%;
      background: var(--grass) no-repeat center bottom;
      background-size: cover; z-index:1; transform:translateY(100px);
      transition:background 1s ease;
    }

    /* ----- B·ªê C·ª§C 3 C·ªòT: PET | CAMERA | CHAT ----- */
    .container{
      position:relative; z-index:2;
      display:grid;
      grid-template-columns: 1fr 0.9fr 1.1fr; /* pet | camera | chat */
      align-items:end; justify-content:center; justify-items:center;
      width:94%; margin:0 auto; gap:20px;
    }

    /* ----- PET ----- */
    .pet-area{ position:relative; display:flex; align-items:flex-end; justify-content:center; height:1000px; }
    model-viewer{
      width:min(600px,50vw); height:min(600px,50vw);
      background:transparent; --poster-color:transparent;
      filter:drop-shadow(0 8px 18px rgba(0,0,0,.15));
      transform: translate(100px, -100px);
      transition: all .3s ease;
    }
    .bubble{
      position:absolute; top:40px; left:58%;
      background:var(--panel); padding:18px 26px; border-radius:50px;
      box-shadow:0 10px 24px var(--shadow1); border:1px solid var(--border);
      font-weight:600; color:var(--brand); transition:all .3s ease;
    }

    /* ----- CAMERA + MIC (new) ----- */
    .ai-controls{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px;
      background:var(--panel); border:1px solid var(--border); border-radius:20px; padding:20px;
      box-shadow:0 8px 20px var(--shadow1);
      transform: translateY(-60px);
      width:280px;
    }
    .ai-controls video{ border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,.25); }
    .ai-controls .btns{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .ai-controls button{
      border:none; padding:8px 14px; border-radius:10px;
      background:linear-gradient(90deg, var(--user), var(--brand)); color:#fff; font-weight:600; cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.2); transition:transform .2s ease;
    }
    .ai-controls button:hover{ transform:scale(1.05); }
    .emotion-status{ font-weight:600; color:var(--brand); font-size:15px; text-align:center; }

    /* ----- CHAT BOX ----- */
    .chat-box{
      background:var(--panel); border:1px solid var(--border); border-radius:40px;
      box-shadow:0 8px 20px var(--shadow1);
      display:flex; flex-direction:column;
      height:620px; width:520px; max-width:90vw;
      position:relative; overflow:hidden;
      transform: translateX(-40px) translateY(-90px);
      transition: all .4s ease;
    }
    .chat-header{
      background:var(--nav); padding:18px 22px; font-weight:700; font-size:22px; color:var(--brand);
      border-bottom:1px solid var(--shadow2); text-align:center; transition:all .3s ease;
    }
    body.dark .chat-header{ color:var(--text); }

    .chat-body{ flex:1; padding:20px; overflow:auto; background:transparent; }
    .msg{
      max-width:75%; margin:8px 0; padding:12px 14px; border-radius:50px; border:1px solid var(--border);
      position:relative; word-wrap:break-word; white-space:pre-wrap; transition: all .3s ease;
    }
    .msg.bot{ background:var(--panel); color:var(--text); border-color:var(--brand); }
    .msg.user{ background:var(--user); color:#fff; margin-left:auto; }

    .msg.bot::before{
      content:""; position:absolute; left:-8px; top:10px;
      border-right:8px solid var(--panel); border-top:8px solid transparent; border-bottom:8px solid transparent;
    }
    .msg.user::before{
      content:""; position:absolute; right:-8px; top:10px;
      border-left:8px solid var(--user); border-top:8px solid transparent; border-bottom:8px solid transparent;
    }

    .chat-footer{
      padding:14px 16px; border-top:1px solid var(--border); background:var(--nav);
      display:flex; align-items:center; gap:10px; transition:all .3s ease;
    }
    .mic{
      width:48px; height:48px; border-radius:30px; border:1px solid var(--border);
      background:var(--panel); display:grid; place-items:center; cursor:pointer; box-shadow:0 6px 14px var(--shadow1);
      position:relative; overflow:hidden; transition:transform .2s ease, box-shadow .2s ease;
    }
    .mic svg{ width:22px; height:22px; color:var(--brand); }

    /* ‚ú® Hi·ªáu ·ª©ng khi ƒëang nghe */
    .mic.listening{
      transform: scale(1.06);
      box-shadow: 0 0 0 3px rgba(75,107,173,.2), 0 0 18px rgba(75,107,173,.45);
    }
    .mic.listening::after{
      content:"";
      position:absolute; inset:0;
      border-radius:30px;
      animation: pulse 1.2s ease-out infinite;
      border:2px solid rgba(75,107,173,.45);
    }
    @keyframes pulse{
      0%{ transform:scale(1); opacity:.9; }
      100%{ transform:scale(1.35); opacity:0; }
    }

    body.dark .chat-footer{ background:transparent; border-top:none; display:flex; align-items:center; justify-content:center; gap:12px; padding:18px 20px; }
    body.dark .mic{
      border:none; background:radial-gradient(circle at 30% 30%, #AFC3FF, #3B4B8E 70%);
      box-shadow:0 0 10px rgba(112,142,255,.6), 0 0 25px rgba(112,142,255,.3);
    }
    body.dark .mic.listening{
      box-shadow:0 0 18px rgba(157,184,255,.9), 0 0 34px rgba(157,184,255,.5);
    }
    body.dark .mic svg{ color:#fff; opacity:.9; }

    .input-wrap{
      flex:1; display:flex; align-items:center; gap:10px;
      background:var(--panel); border:1px solid var(--border); border-radius:30px; padding:8px 10px;
    }
    .input-wrap input{
      flex:1; border:none; outline:none; font-size:15px; padding:6px 8px; color:var(--text); background:transparent;
    }
    .send{
      border:none; border-radius:12px; background:linear-gradient(90deg,var(--user),var(--brand));
      color:#fff; padding:10px 18px; font-weight:600; cursor:pointer;
      box-shadow:0 6px 14px rgba(79,70,229,.25); transition:all .3s ease;
    }

    body.dark .input-wrap{
      background:rgba(36,38,90,.8);
      border:1px solid rgba(105,126,255,.25);
      border-radius:24px; padding:12px 18px;
      box-shadow: inset 0 0 6px rgba(100,130,255,.2), 0 0 12px rgba(55,80,200,.25);
    }
    body.dark .input-wrap input{ color:#fff; }
    body.dark .input-wrap input::placeholder{ color:rgba(255,255,255,.6); font-style:italic; }

    @media (max-width:1000px){
      .main::after{ width:100%; }
      .container{ grid-template-columns:1fr; }
      .pet-area{ height:460px; }
      .chat-box{ width:100%; transform:none; }
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">üê∂ S√∫p AI Pet</div>
    <nav>
      <a href="#" class="active">Home</a>
      <a href="AboutUs.html" class="nav-link">About us</a>
      <a href="#" id="modeToggle">Mode</a>
    </nav>
  </header>

  <section class="main">
    <div class="container">
      <!-- üê∂ PET -->
      <div class="pet-area">
        <model-viewer src="supnheomatmomieng.glb" autoplay auto-rotate camera-controls disable-zoom></model-viewer>
      </div>

      <!-- üé• CAMERA + NH·∫¨N DI·ªÜN -->
      <div class="ai-controls">
        <video id="preview" autoplay playsinline muted width="240" height="180"></video>
        <div class="btns">
          <button id="startCamBtn">üé• B·∫≠t camera</button>
          <button id="stopCamBtn">‚èπÔ∏è T·∫Øt camera</button>
        </div>
        <div class="emotion-status">
          ·∫¢nh: <span id="emotion">‚Äì</span> |
          Gi·ªçng: <span id="voiceEmotion">‚Äì</span> |
          T·ªïng h·ª£p: <span id="finalEmotion">‚Äì</span>
        </div>
      </div>

      <!-- üí¨ CHAT -->
      <div class="chat-box">
        <div class="chat-header">Tr√≤ chuy·ªán v·ªõi S√∫p</div>
        <div id="chatBody" class="chat-body">
          <div class="msg bot">Xin ch√†o üëã M√¨nh l√† S√∫p!</div>
        </div>
        <div class="chat-footer">
          <div class="mic" id="sttMic" title="Nh·∫•n ƒë·ªÉ n√≥i / Nh·∫•n l·∫ßn n·ªØa ƒë·ªÉ g·ª≠i">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3Z"/>
              <path d="M19 11a7 7 0 0 1-14 0"/>
              <path d="M12 18v3"/>
            </svg>
          </div>
          <div class="input-wrap">
            <input id="msgInput" type="text" placeholder="Nh·∫•n mic ƒë·ªÉ n√≥i..." />
            <button id="sendBtn" class="send">G·ª≠i</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    /* =========================
       CONFIG CHAT (Gemini)
    ========================== */
    const USE_PROXY      = false; // true n·∫øu b·∫°n d√πng proxy
    const PROXY_URL      = "http://localhost:8080/proxy/generate";
    const GEMINI_API_KEY = "AIzaSyDH2LC1KP9bJKTbIXy2ysxYFZwADxWD4mg"; // demo cho localhost
    const GEMINI_MODEL   = "gemini-2.0-flash";

    function geminiEndpoint() {
      if (USE_PROXY) return PROXY_URL;
      return `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
    }

    /* ====== Toggle s√°ng/t·ªëi ====== */
    const modeBtn = document.getElementById("modeToggle");
    modeBtn.addEventListener("click", (e) => {
      e.preventDefault();
      document.body.classList.toggle("dark");
      modeBtn.textContent = document.body.classList.contains("dark") ? "Light Mode" : "Dark Mode";
    });

    /* ====== Chat (Gemini) + TTS ====== */
    const chatBody = document.getElementById('chatBody');
    const input    = document.getElementById('msgInput');
    const send     = document.getElementById('sendBtn');

    function addMsg(text, who='bot'){
      const div = document.createElement('div');
      div.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
      div.textContent = text;
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
      return div;
    }

    async function sendMessage(){
      const val = input.value.trim();
      if(!val) return;
      addMsg(val, 'user');
      input.value='';
      const thinking = addMsg('‚è≥ ƒêang nghƒ©...', 'bot');

      const sys =
`B·∫°n l√† S√∫p ‚Äì th√∫ c∆∞ng d·ªÖ th∆∞∆°ng bi·∫øt n√≥i chuy·ªán.
Vai tr√≤: an ·ªßi v√† h·ªó tr·ª£ tinh th·∫ßn c∆° b·∫£n (KH√îNG ch·∫©n ƒëo√°n y t·∫ø).
Quy t·∫Øc:
1) Vi·∫øt ng·∫Øn 2‚Äì3 c√¢u, gi·ªçng ·∫•m √°p v·ªõi emoji üê∂üíñ‚ú®.
2) C√¥ng nh·∫≠n c·∫£m x√∫c tr∆∞·ªõc, r·ªìi ƒë·ªông vi√™n t√≠ch c·ª±c.
3) G·ª£i √Ω m·ªôt h√†nh ƒë·ªông nh·ªè an to√†n (h√≠t th·ªü, ngh·ªâ ng∆°i‚Ä¶).
4) Kh√¥ng ƒë∆∞a l·ªùi khuy√™n y t·∫ø ph·ª©c t·∫°p.
5) N·∫øu c√≥ d·∫•u hi·ªáu t·ª± h·∫°i r√µ r√†ng ‚Üí "M√¨nh r·∫•t lo cho b·∫°n ü•∫, m√¨nh ƒë√£ nh·ªù th·∫ßy c√¥ v√† ng∆∞·ªùi l·ªõn h·ªó tr·ª£ th√™m cho b·∫°n ngay nh√©."
6) N·∫øu l√† th√†nh ng·ªØ ki·ªÉu "m·ªát mu·ªën ch·∫øt" (kh√¥ng √Ω ƒë·ªãnh th·ª±c) th√¨ coi l√† c√°ch n√≥i th∆∞·ªùng, ƒë·ª´ng k√≠ch ho·∫°t c·∫£nh b√°o.
N·∫øu kh√¥ng ch·∫Øc ch·∫Øn v·ªÅ √Ω ƒë·ªãnh, h·ªèi nh·∫π v√† ƒë·ªÅ ngh·ªã h·ªó tr·ª£ t·ª´ ng∆∞·ªùi l·ªõn.`;

      try{
        const url  = geminiEndpoint();
        const body = USE_PROXY
          ? { model: GEMINI_MODEL, contents: [{ parts: [{ text: sys + "\n\nNg∆∞·ªùi d√πng: " + val }] }] }
          : { contents: [{ parts: [{ text: sys + "\n\nNg∆∞·ªùi d√πng: " + val }] }] };

        const res  = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const raw = await res.text();
        if(!res.ok){
          thinking.textContent = `‚ö†Ô∏è L·ªói HTTP ${res.status}`;
          console.warn("Gemini error:", raw);
          return;
        }
        let data;
        try{ data = JSON.parse(raw); }
        catch{ thinking.textContent = "‚ö†Ô∏è Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá."; return; }

        const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text
                    || "M√¨nh ch∆∞a nghe r√µ, b·∫°n n√≥i l·∫°i nh√© üê∂";
        thinking.textContent = reply;

        const u = new SpeechSynthesisUtterance(reply);
        u.lang = "vi-VN";
        window.speechSynthesis.speak(u);

      }catch(err){
        console.error(err);
        thinking.textContent = "‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Gemini.";
      }
    }

    send.addEventListener('click', sendMessage);
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') send.click(); });

    /* =========================
       STT (Toggle Mic) + T·ª∞ B·∫¨T/T·∫ÆT c·∫£m x√∫c gi·ªçng
    ========================== */
    const micBtn = document.getElementById('sttMic');
    let rec = null, recActive = false;
    let sttFinal = "", sttInterim = "";

    function initSTT(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){
        alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ n√≥i ƒë·ªÉ nh·∫≠p (SpeechRecognition).");
        return null;
      }
      const r = new SR();
      r.lang = "vi-VN";
      r.interimResults = true;
      r.continuous = true;

      r.onstart = async ()=>{
        recActive = true;
        sttFinal = ""; sttInterim = "";
        micBtn.classList.add('listening');
        input.placeholder = "ƒêang nghe... n√≥i ƒëi nh√©!";

        // üîî T·ª∞ B·∫¨T NH·∫¨N DI·ªÜN C·∫¢M X√öC GI·ªåNG
        if (!audioModel) { await initAudioModel(); }
        else { await startAudioEmotion(); }
      };

      r.onresult = (ev)=>{
        sttInterim = "";
        for (let i = ev.resultIndex; i < ev.results.length; i++) {
          const chunk = ev.results[i][0].transcript;
          if (ev.results[i].isFinal) sttFinal += chunk + " ";
          else sttInterim += chunk;
        }
        input.value = (sttFinal + sttInterim).trim();
      };

      r.onerror = (e)=>{
        console.warn("STT error", e);
        recActive = false;
        micBtn.classList.remove('listening');
        input.placeholder = "Nh·∫•n mic ƒë·ªÉ n√≥i...";
      };

      r.onend = async ()=>{
        // üîï T·∫ÆT NH·∫¨N DI·ªÜN GI·ªåNG khi d·ª´ng n√≥i
        await stopAudioEmotion();

        micBtn.classList.remove('listening');
        recActive = false;
        input.placeholder = "Nh·∫•n mic ƒë·ªÉ n√≥i...";
        const toSend = (input.value || "").trim();
        if(toSend) { await sendMessage(); }
      };

      return r;
    }

    micBtn.addEventListener('click', ()=>{
      if(!rec) rec = initSTT();
      if(!rec) return;
      try{
        if(recActive) { rec.stop(); }  // l·∫ßn 2: d·ª´ng ‚Üí onend s·∫Ω t·ª± g·ª≠i
        else         { rec.start(); }  // l·∫ßn 1: b·∫Øt ƒë·∫ßu nghe + hi·ªáu ·ª©ng
      }catch(e){ console.warn(e); }
    });

    /* =========================
       Teachable Machine ‚Äì ·∫¢nh & √Çm thanh (c·∫£m x√∫c)
    ========================== */
    let imageModel, audioModel, webcam;

    const IMAGE_MODEL_URL = "./NhanDienCamXuc/";
    const AUDIO_MODEL_URL = "./NhanDienAmThanh/"; // c√≥ model.json + metadata.json (+ weights)

    function updateFinalEmotion(){
      const img = document.getElementById('emotion').textContent || "UNKNOWN";
      const voice = document.getElementById('voiceEmotion').textContent || "UNKNOWN";
      const final = (voice && voice!=="UNKNOWN") ? voice : img;
      document.getElementById('finalEmotion').textContent = final;
    }

    // Chu·∫©n ho√° nh√£n √¢m thanh -> nh√≥m chu·∫©n
    function normalizeVoiceLabel(label){
      const up = (label || "")
        .toUpperCase()
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu,""); // b·ªè d·∫•u ti·∫øng Vi·ªát

      if (up.includes("VUI") || up.includes("HAPPY") || up.includes("JOY")) return "HAPPY";
      if (up.includes("BUON") || up.includes("SAD") || up.includes("TRAM")) return "SAD";
      if (up.includes("GIAN") || up.includes("ANGRY") || up.includes("TUC")) return "ANGRY";
      if (up.includes("NEUTRAL") || up.includes("BINH") || up.includes("BT")) return "NEUTRAL";
      if (up.includes("SILENCE") || up.includes("NOISE") || up.includes("BACKGROUND")) return "UNKNOWN";
      return "UNKNOWN";
    }

    async function predictImage(){
      if(!imageModel || !webcam) return;
      try{
        const pred = await imageModel.predict(webcam.canvas);
        if(!pred?.length) return;
        const best = pred.reduce((a,b)=> a.probability>b.probability ? a : b);
        document.getElementById('emotion').textContent = best.className || "UNKNOWN";
        updateFinalEmotion();
      }catch(e){ console.warn("predictImage error", e); }
    }

    async function initImageModel(){
      try{
        imageModel = await tmImage.load(IMAGE_MODEL_URL + "model.json", IMAGE_MODEL_URL + "metadata.json");
        console.log("‚úÖ Model ·∫£nh s·∫µn s√†ng");
        await startCam();
      }catch(e){
        console.error("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c model ·∫£nh:", e);
        alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c model ·∫£nh. Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n NhanDienCamXuc/");
      }
    }

    async function startCam(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ video:true });
        document.getElementById('preview').srcObject = stream;

        webcam = new tmImage.Webcam(200, 200, true);
        await webcam.setup({ facingMode:"user" });
        await webcam.play();

        const loopPredict = async () => {
          webcam.update();
          await predictImage();
          requestAnimationFrame(loopPredict);
        };
        loopPredict();

      }catch(err){
        console.error("‚ùå Kh√¥ng th·ªÉ b·∫≠t camera:", err);
        alert("Kh√¥ng th·ªÉ b·∫≠t camera. H√£y ch·∫°y tr√™n https ho·∫∑c http://localhost v√† cho ph√©p quy·ªÅn.");
      }
    }

    // D√πng create() ƒë·ªÉ t∆∞∆°ng th√≠ch t·ªët v·ªõi TM Audio 0.8
    async function initAudioModel(){
      try{
        await navigator.mediaDevices.getUserMedia({ audio:true }); // xin quy·ªÅn mic
        const base = AUDIO_MODEL_URL.endsWith('/') ? AUDIO_MODEL_URL : (AUDIO_MODEL_URL + '/');
        audioModel = await tmAudio.create(base + "model.json", base + "metadata.json");
        console.log("‚úÖ Model √¢m thanh s·∫µn s√†ng");
        console.log("üîé Nh√£n l·ªõp audio:", audioModel.getClassLabels?.() || "(kh√¥ng h·ªó tr·ª£ API)");
        await startAudioEmotion();
      }catch(e){
        console.error("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c model √¢m thanh:", e);
        alert("Ch∆∞a c√≥ model √¢m thanh ho·∫∑c ch∆∞a c·∫•p quy·ªÅn micro. Ki·ªÉm tra NhanDienAmThanh/");
      }
    }

    async function startAudioEmotion(){
      if(!audioModel) return;
      try{
        try{ await audioModel.stopListening(); }catch{}
        await audioModel.listen(preds => {
          if(!preds?.length) return;

          // Log top-3 ƒë·ªÉ debug nh√£n + x√°c su·∫•t
          try{
            const top3 = preds.slice().sort((a,b)=>b.probability-a.probability).slice(0,3);
            console.table(top3);
          }catch{}

          const best = preds.reduce((a,b)=> a.probability>b.probability ? a : b);
          const rawLabel = best.className || "UNKNOWN";
          const norm = normalizeVoiceLabel(rawLabel);

          // Hi·ªán nh√£n chu·∫©n n·∫øu map ƒë∆∞·ª£c, ng∆∞·ª£c l·∫°i hi·ªán nh√£n g·ªëc ƒë·ªÉ b·∫°n ƒëi·ªÅu ch·ªânh mapping
          document.getElementById('voiceEmotion').textContent = (norm !== "UNKNOWN") ? norm : rawLabel;
          updateFinalEmotion();
        }, {
          includeSpectrogram: false,
          overlapFactor: 0.5,
          probabilityThreshold: 0.4 // c√≥ th·ªÉ tinh ch·ªânh 0.35‚Äì0.6 tu·ª≥ m√¥i tr∆∞·ªùng
        });
        console.log("üé§ ƒêang nh·∫≠n di·ªán c·∫£m x√∫c qua gi·ªçng n√≥i...");
      }catch(err){
        console.error("‚ùå L·ªói b·∫≠t mic (audio emotion):", err);
      }
    }

    async function stopAudioEmotion(){
      try { await audioModel?.stopListening(); }
      catch(e) { console.warn("Kh√¥ng th·ªÉ d·ª´ng audioModel:", e); }
      // Kh√¥ng xo√° text ƒë·ªÉ b·∫°n v·∫´n th·∫•y nh√£n cu·ªëi c√πng
      console.log("‚èπÔ∏è ƒê√£ t·∫Øt nh·∫≠n di·ªán c·∫£m x√∫c gi·ªçng.");
    }

    /* ====== N√∫t ƒëi·ªÅu khi·ªÉn Camera ====== */
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("startCamBtn").onclick = initImageModel;
      document.getElementById("stopCamBtn").onclick  = () => location.reload();
    });
  </script>
</body>
</html>
