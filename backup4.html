<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üê∂ AI Pet Robot ‚Äì Voice & Face Emotion</title>

  <!-- LIBRARIES -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/audio@0.8/dist/teachablemachine-audio.min.js"></script>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
    :root{
      --bg1:#e0f7fa; --bg2:#f1f8ff; --text:#0f172a; --muted:#64748b;
      --border:#d0e0f0; --card:#ffffffcc; --accent:#06b6d4; --accent2:#10b981;
      --arena-h:56vh; --arena-min:360px; --track-w:min(92vw,1100px); --pet-w:320px;
    }
    *{box-sizing:border-box;transition:all .25s ease}
    body{font-family:'Poppins',sans-serif;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh;overflow-x:hidden}

    /* SETTINGS OVERLAY */
    #settingsOverlay{
      position:fixed; inset:0; background:rgba(255,255,255,.95);
      display:flex; align-items:center; justify-content:center; z-index:10002;
    }
    .settings-box{ background:#fff; border-radius:16px; padding:24px 26px; width:min(520px,94%);
      box-shadow:0 8px 24px rgba(0,0,0,.15); }
    .settings-box h2{ margin:0 0 10px; color:var(--accent); text-align:center }
    .settings-grid{ display:grid; gap:16px; grid-template-columns:1fr 1fr }
    .settings-section{ border:1px solid var(--border); border-radius:12px; padding:12px 14px; background:#fff }
    .settings-section h4{ margin:0 0 8px; color:var(--muted) }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border);
      border-radius:999px; margin:4px 6px 0 0; cursor:pointer; user-select:none }
    .pill input{ accent-color:var(--accent); }
    .pill:hover{ border-color:var(--accent) }
    .settings-actions{ display:flex; gap:10px; justify-content:center; margin-top:14px }
    #micBtn{ display:none } /* hi·ªán khi ·ªü mode voice */

    /* TOAST */
    #toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      background:#0f172a; color:#fff; padding:10px 14px; border-radius:10px;
      box-shadow:0 8px 18px rgba(0,0,0,.2); font-size:14px; z-index:10001;
      opacity:0; pointer-events:none; transition:opacity .25s ease;
    }
    #toast.show{ opacity:1 }

    /* POPUPS */
  #endConfirmOverlay{
    position:fixed; inset:0; background:rgba(255,255,255,0.9);
    display:flex; align-items:center; justify-content:center; z-index:9999;
  }

    #endConfirmOverlay{ display:none; z-index:10000; }
    .popup-box{
      background:#fff; border-radius:16px; padding:28px 32px; max-width:380px; width:90%;
      box-shadow:0 8px 24px rgba(0,0,0,0.15); text-align:center; animation:fadeIn .3s ease;
    }
    .popup-box h2{ color:var(--accent); margin:0 0 8px }
    .popup-box label{ display:block; text-align:left; margin-top:10px; font-weight:500; color:var(--muted) }
    .popup-box input{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border); margin-top:4px; font-size:14px }
    .popup-box input:focus{ border-color:var(--accent); outline:none }
    .popup-box button{ margin-top:14px }
    @keyframes fadeIn{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}

    /* HEADER */
    header{text-align:center;padding:24px 16px 10px}
    h1{font-size:clamp(26px,3vw,34px);margin:0;background:linear-gradient(90deg,#06b6d4,#10b981);-webkit-background-clip:text;color:transparent;font-weight:600;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:15px;margin-top:6px}

    /* ARENA */
    .arena{width:100%;display:flex;align-items:center;justify-content:center;height:var(--arena-h);min-height:var(--arena-min);background:radial-gradient(circle at center,#d7fafa 0%,#e8f7ff 80%);border-top:2px solid #b3ecf5;border-bottom:2px solid #b3ecf5;box-shadow:inset 0 0 20px #c8f1ff}
    .track{width:var(--track-w);height:100%;position:relative;margin:0 auto;overflow:hidden}
    .pet-walk{position:absolute;bottom:0;left:0;width:var(--pet-w);will-change:transform;animation:patrol 14s ease-in-out infinite;transform-origin:center bottom;pointer-events:none}
    @keyframes patrol{
      0%{transform:translateX(0) scaleX(1);} 50%{transform:translateX(calc(var(--track-w) - var(--pet-w))) scaleX(1);}
      51%{transform:translateX(calc(var(--track-w) - var(--pet-w))) scaleX(-1);} 100%{transform:translateX(0) scaleX(-1);}
    }
    model-viewer.pet{width:100%;height:min(54vh,420px);background:transparent;--poster-color:transparent;filter:drop-shadow(0 0 20px rgba(0,255,255,.3));border:none}

    /* GRID + CARDS */
    .container{max-width:1100px;margin:24px auto 50px;padding:0 16px}
    .grid{display:grid;gap:24px;grid-template-columns:1fr 1fr}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}
    .box{background:var(--card);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:18px;padding:20px 22px;box-shadow:0 8px 18px rgba(0,0,0,0.08);position:relative}
    .box h3{margin:0 0 14px;color:var(--accent);font-weight:600;text-align:center;font-size:18px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center}
    select,button,textarea{font-family:'Poppins',sans-serif;font-size:14px}
    select{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    button{padding:10px 18px;border-radius:12px;border:1px solid var(--border);background:#e6faff;cursor:pointer;font-weight:500;color:#03696b}
    button:hover{background:var(--accent);color:#fff;box-shadow:0 0 8px rgba(0,180,200,.4)}
    button.primary{background:var(--accent2);border-color:var(--accent2);color:#fff}
    button.primary:hover{background:#0ea36e;box-shadow:0 0 10px rgba(16,185,129,.4)}
    button:disabled{opacity:.6;cursor:not-allowed}

    /* CAMERA + CHAT */
    #webcam{width:100%;max-width:300px;aspect-ratio:1/1;border-radius:14px;overflow:hidden;border:2px dashed var(--border);background:#f8fafc;display:flex;align-items:center;justify-content:center;margin:auto}
    #rawVideoWrap video{border-radius:10px;box-shadow:0 0 8px rgba(0,0,0,0.15)}
    #emotionBar{display:flex;gap:8px;align-items:center;font-weight:600;justify-content:center;margin-top:4px}
    #emotion{padding:4px 10px;border-radius:10px;background:#ccfbf1;border:1px solid #99f6e4;color:#047857}
    #diag{text-align:center;margin:6px 0 0}
    #userText{width:100%;min-height:96px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);resize:vertical;background:#fff}
    #userText:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 3px #a5f3fc}
    #reply{padding:14px;background:#f8fafc;border:1px solid var(--border);border-radius:12px;min-height:150px;max-height:360px;overflow:auto;margin-top:12px}
    .msg{margin:8px 0;background:#fff;padding:8px 10px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
    .msg b{color:var(--accent2)}
  </style>
</head>

<body>
  <!-- Open Settings button -->
  <button id="openSettingsBtn" style="position:fixed; right:14px; bottom:14px; z-index:10001">‚öôÔ∏è</button>

  <header>
    <h1>üê∂ AI Pet Robot ‚Äì Voice & Face Emotion</h1>
    <p class="sub">D·ª± √°n do c√°c h·ªçc sinh ∆∞u t√∫ c·ªßa th·∫ßy Ph∆∞∆°ng l√™n √Ω t∆∞·ªüng v√† ph√°t tri·ªÉn</p>
  </header>

  <section class="arena" aria-label="Khu v·ª±c th√∫ c∆∞ng AI">
    <div class="track" id="track">
      <div class="pet-walk" id="petWalk">
        <model-viewer id="pet3d" class="pet" src="supp.glb"></model-viewer>
      </div>
    </div>
  </section>

  <!-- SETTINGS OVERLAY -->
  <div id="settingsOverlay">
    <div class="settings-box">
      <h2>‚öôÔ∏è C√†i ƒë·∫∑t nhanh</h2>
      <div class="settings-grid">
        <div class="settings-section">
          <h4>1) Ch·ªçn Font</h4>
          <label class="pill"><input type="radio" name="fontPick" value="Poppins" checked> Poppins</label>
          <label class="pill"><input type="radio" name="fontPick" value="Nunito"> Nunito</label>
          <label class="pill"><input type="radio" name="fontPick" value="Quicksand"> Quicksand</label>

          <h4 style="margin-top:10px">Ch·ªçn N·ªÅn</h4>
          <label class="pill"><input type="radio" name="bgPick" value="aqua" checked> Aqua</label>
          <label class="pill"><input type="radio" name="bgPick" value="pastel"> Pastel</label>
          <label class="pill"><input type="radio" name="bgPick" value="dark"> T·ªëi</label>
        </div>

        <div class="settings-section">
          <h4>2) Ph∆∞∆°ng th·ª©c tr√≤ chuy·ªán</h4>
          <label class="pill"><input type="radio" name="modePick" value="voice" checked> Gi·ªçng n√≥i + Khu√¥n m·∫∑t</label>
          <label class="pill"><input type="radio" name="modePick" value="chat"> Chat + Khu√¥n m·∫∑t</label>
          <p class="hint" style="margin-top:8px">‚Ä¢ Voice: micro + camera + TTS.<br>‚Ä¢ Chat: g√µ vƒÉn b·∫£n + camera.</p>
        </div>
      </div>
      <div class="settings-actions">
        <button id="saveSettingsBtn" class="primary">L∆∞u & Ti·∫øp t·ª•c</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- CAMERA -->
      <section class="box" aria-labelledby="cam-title">
        <h3 id="cam-title">üé• Camera & Nh·∫≠n di·ªán c·∫£m x√∫c</h3>
        <div class="row" style="gap:8px">
          <select id="camSelect" style="min-width:240px"></select>
          <button id="refreshBtn" title="Qu√©t l·∫°i camera">Qu√©t camera</button>
          <label style="display:flex;align-items:center;gap:6px;font-size:14px">
            <input type="checkbox" id="debugToggle"> Debug video
          </label>
        </div>

        <div id="webcamWrap" style="display:flex;flex-direction:column;gap:10px">
          <div id="webcam"><span class="hint">Video 1:1 s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y sau khi b·∫≠t camera</span></div>
          <div id="rawVideoWrap" style="display:none; text-align:center">
            <video id="rawVideo" autoplay playsinline muted style="max-width:300px;border-radius:10px;border:1px solid var(--border)"></video>
            <div class="hint">Xem tr·ª±c ti·∫øp lu·ªìng camera (debug)</div>
          </div>

          <div id="emotionBar">C·∫£m x√∫c camera: <span id="emotion">‚Äì</span></div>
          <div id="voiceEmotionBar" class="hint" style="text-align:center">
            üéôÔ∏è Gi·ªçng n√≥i: <b id="voiceEmotion">‚Äì</b> <span id="voicePitch" style="opacity:.75"></span>
          </div>
          <div id="finalEmotionBar" style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:6px;font-weight:600">
            T·ªïng h·ª£p: <span id="finalEmotion" style="padding:4px 10px;border-radius:10px;background:#fef9c3;border:1px solid #fde68a;color:#92400e">‚Äì</span>
          </div>

          <p id="diag" class="hint">‚è≥ Ch∆∞a kh·ªüi ƒë·ªông.</p>

          <div class="row">
            <button id="startBtn" class="primary">B·∫Øt ƒë·∫ßu</button>
            <button id="stopBtn" disabled>D·ª´ng</button>
          </div>

          <p class="hint" style="text-align:center">
            Y√™u c·∫ßu ch·∫°y tr√™n HTTPS ho·∫∑c <code>http://localhost</code> ƒë·ªÉ truy c·∫≠p camera/micro.
          </p>
        </div>
      </section>

      <!-- CHAT -->
      <section class="box" aria-labelledby="chat-title">
        <h3 id="chat-title">üí¨ Tr√≤ chuy·ªán v·ªõi Gemini</h3>
        <textarea id="userText" placeholder="Nh·∫≠p l·ªùi b·∫°n mu·ªën n√≥i..."></textarea>
        <div class="row">
          <button id="chatBtn" class="primary">G·ª≠i</button>
          <button id="micBtn" title="Nh·∫•n ƒë·ªÉ n√≥i">üé§ N√≥i</button>
          <button id="clearBtn" title="Xo√° khung chat">Xo√°</button>
          <button id="endBtn" title="K·∫øt th√∫c phi√™n">K·∫øt th√∫c</button>
        </div>
        <div id="reply" aria-live="polite" aria-busy="false"></div>
        <p class="hint">‚ö†Ô∏è Kh√¥ng nh√∫ng API key tr·ª±c ti·∫øp tr√™n client cho m√¥i tr∆∞·ªùng th·∫≠t; h√£y d√πng backend/proxy.</p>
      </section>
    </div>
  </div>
  <!-- END CONFIRM POPUP -->
  <div id="endConfirmOverlay">
    <div class="popup-box">
      <h2>üîî K·∫øt th√∫c phi√™n</h2>
      <p>B·∫°n c√≥ mu·ªën nh·∫≠n th√™m nh·ªØng l·ªùi khuy√™n h·ªØu √≠ch t·ª´ chuy√™n gia t√¢m l√Ω ch·ª©?</p>
      <div class="row" style="margin-top:8px">
        <button id="endYesBtn" class="primary">C√≥</button>
        <button id="endNoBtn">Kh√¥ng</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- ================== SCRIPT ================== -->
  <script>
    /* ================== CONFIG ================== */
    const IMAGE_MODEL_URL = "./NhanDienCamXuc/";     // Th∆∞ m·ª•c ch·ª©a model ·∫£nh: model.json, metadata.json
    const AUDIO_MODEL_URL = "./NhanDienAmThanh/";    // Th∆∞ m·ª•c ch·ª©a model √¢m thanh: model.json, metadata.json, weights.bin
    const GEMINI_API_KEY  = "AIzaSyDH2LC1KP9bJKTbIXy2ysxYFZwADxWD4mg";     // Demo: ƒë·ªÉ tr·ªëng ho·∫∑c thay b·∫±ng key th·ª≠ nghi·ªám. Deploy th·∫≠t: g·ªçi qua backend/proxy.
    const GEMINI_MODEL    = "gemini-2.5-flash";
    const SEND_API_URL    = "http://localhost:3000/api/send-report";

    /* ================== UTILITIES ================== */
    function $(id){ return document.getElementById(id); }
    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>t.classList.remove("show"), 2500);
    }

    /* ================== THEME / MODE ================== */
    function applyFont(font){
      const head = document.head;
      const id = "dynamic-font";
      const exist = document.getElementById(id);
      const map = {
        "Poppins":"Poppins:wght@400;500;600",
        "Nunito":"Nunito:wght@400;600;700",
        "Quicksand":"Quicksand:wght@400;600;700"
      };
      const fam = map[font] || map.Poppins;
      if(exist) exist.remove();
      const link = document.createElement("link");
      link.id = id;
      link.rel = "stylesheet";
      link.href = `https://fonts.googleapis.com/css2?family=${fam}&display=swap`;
      head.appendChild(link);
      document.body.style.fontFamily = `'${font}', sans-serif`;
    }
    function applyBackground(bg){
      if(bg==="dark"){
        document.body.style.background = "#0b1120";
        document.body.style.color = "#e2e8f0";
      }else if(bg==="pastel"){
        document.body.style.background = "linear-gradient(180deg,#fff7f9,#f4faff)";
        document.body.style.color = "var(--text)";
      }else{
        document.body.style.background = "linear-gradient(180deg,var(--bg1),var(--bg2))";
        document.body.style.color = "var(--text)";
      }
    }
    function setModeUI(mode){
      const isVoice = mode === "voice";
      $("userText").style.display = isVoice ? "none" : "block";
      $("chatBtn").style.display  = isVoice ? "none" : "inline-block";
      $("micBtn").style.display   = isVoice ? "inline-block" : "none";
      if(isVoice){
        startAudioEmotion();   // b·∫≠t nh·∫≠n di·ªán c·∫£m x√∫c gi·ªçng n√≥i b·∫±ng Teachable Machine Audio
      }else{
        stopAudioEmotion();    // t·∫Øt khi chuy·ªÉn sang chat
      }
    }

    /* ================== GLOBALS ================== */
    let imageModel = null;     // Teachable Machine IMAGE model (nh·∫≠n di·ªán c·∫£m x√∫c khu√¥n m·∫∑t)
    let audioModel = null;     // Teachable Machine AUDIO model (nh·∫≠n di·ªán c·∫£m x√∫c gi·ªçng n√≥i)
    let webcam = null;         // tmImage.Webcam
    let loopId = null;
    let isRunning = false;
    let ended = false;

    let audioListening = false;  // tr·∫°ng th√°i listen() c·ªßa tmAudio
    let lastVoiceLabel = "UNKNOWN";  // nh√£n c·∫£m x√∫c gi·ªçng n√≥i hi·ªán t·∫°i

    /* ================== USER INFO ================== */
    function getUserInfoSession(){
      try{
        const r = sessionStorage.getItem("userInfo");
        return r ? JSON.parse(r) : null;
      }catch{ return null; }
    }
    function setUserInfoSession(info){
      sessionStorage.setItem("userInfo", JSON.stringify(info));
    }

    /* ================== IMAGE EMOTION (Teachable Machine Image) ================== */
    async function initImageModel(){
      const base = IMAGE_MODEL_URL.replace(/\/?$/, "/");
      $("diag").innerText = "‚¨áÔ∏è ƒêang t·∫£i model (camera)...";
      try{
        imageModel = await tmImage.load(base + "model.json", base + "metadata.json");
        $("diag").innerText = "‚úÖ Model ·∫£nh ƒë√£ s·∫µn s√†ng";
      }catch(e){
        console.error(e);
        $("diag").innerText = "‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c model ·∫£nh.";
      }
    }
    async function ensureVideoPermissionOnce(){
      await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
    }
    async function listCameras(){
      const sel = $("camSelect"); sel.innerHTML = "";
      const devs = await navigator.mediaDevices.enumerateDevices();
      const cams = devs.filter(d => d.kind === "videoinput");
      if(!cams.length){ alert("Kh√¥ng t√¨m th·∫•y camera."); return; }
      cams.forEach((c,i)=>{
        const o = document.createElement("option");
        o.value = c.deviceId;
        o.textContent = c.label || `Camera ${i+1}`;
        sel.appendChild(o);
      });
    }
    function stopCam(keep=false){
      if(loopId) cancelAnimationFrame(loopId);
      loopId = null;
      if(webcam){
        try{ webcam.stop(); }catch{}
        webcam = null;
      }
      isRunning = false;
      if(!keep){
        $("startBtn").disabled = false;
        $("stopBtn").disabled = true;
      }
      $("diag").innerText = "‚èπÔ∏è ƒê√£ d·ª´ng camera.";
      const v = $("rawVideo");
      if(v){
        v.pause?.();
        v.srcObject = null;
      }
    }
    async function startCam(){
      stopCam(true);
      $("diag").innerText = "üé• Xin quy·ªÅn camera...";
      await ensureVideoPermissionOnce();
      if(!$("camSelect").options.length) await listCameras();

      const deviceId = $("camSelect").value;
      const flip = true;
      webcam = new tmImage.Webcam(300, 300, flip);
      try{
        await webcam.setup({ deviceId:{ exact:deviceId }, width:{ ideal:1280 }, height:{ ideal:720 } });
      }catch{
        await webcam.setup({ facingMode:"user", width:{ ideal:1280 }, height:{ ideal:720 } });
      }
      await webcam.play();
      isRunning = true;

      $("webcam").innerHTML = "";
      $("webcam").appendChild(webcam.canvas);

      $("diag").innerText = "üü¢ Camera OK ‚Äì ƒëang d·ª± ƒëo√°n...";
      if($("debugToggle").checked){
        $("rawVideoWrap").style.display = "block";
        $("rawVideo").srcObject = webcam.webcam.srcObject;
      }else{
        $("rawVideoWrap").style.display = "none";
      }
      loopId = requestAnimationFrame(loopImagePredict);
    }
    async function loopImagePredict(){
      if(!isRunning) return;
      webcam.update();
      await predictImageEmotion();
      loopId = requestAnimationFrame(loopImagePredict);
    }
    function normalizeLabelToKey(upText){
      // Chu·∫©n ho√° t√™n l·ªõp th√†nh KEY chu·∫©n
      const MAP = {
        HAPPY:["HAPPY","JOY","VUI"],
        SAD:["SAD","BUON","BU·ªíN"],
        ANGRY:["ANGRY","GI·∫¨N","GIAN","T·ª®C","TUC"],
        SURPRISED:["SURPRISED","SURPRISE","NG·∫†C","NGAC"],
        NEUTRAL:["NEUTRAL","BT","B√åNH","BINH","NORMAL","BINH_THUONG","B√åNH TH∆Ø·ªúNG"]
      };
      for(const k in MAP){
        if(MAP[k].some(x => upText.includes(x))) return k;
      }
      return "NEUTRAL";
    }
    function update3DByEmotion(key){
      const mv = $("pet3d");
      const setAnim = (n)=> mv?.setAttribute("animation-name", n);
      const map = { HAPPY:'Happy', SAD:'Sad', ANGRY:'Angry', SURPRISED:'Surprised', NEUTRAL:'Idle' };
      setAnim(map[key] || 'Idle');
    }
    async function predictImageEmotion(){
      if(!imageModel || !webcam) return;
      try{
        const pred = await imageModel.predict(webcam.canvas);
        if(!pred?.length){
          $("emotion").innerText = "‚Äì";
          return;
        }
        const best = pred.reduce((a,b)=> a.probability>b.probability ? a : b);
        const name = (best.className || "").toString();
        const pct  = (best.probability*100).toFixed(1);
        $("emotion").innerText = `${name} ${pct}%`;
        const key = normalizeLabelToKey(name.toUpperCase());
        update3DByEmotion(key);
        updateFinalEmotion(); // h·ª£p nh·∫•t v·ªõi gi·ªçng n√≥i
      }catch(e){
        console.error(e);
        $("emotion").innerText = "L·ªói d·ª± ƒëo√°n ·∫£nh";
      }
    }

    /* ================== AUDIO EMOTION (Teachable Machine Audio) ================== */
    async function initAudioModel(){
      const base = AUDIO_MODEL_URL.replace(/\/?$/, "/");
      try{
        // tmAudio.create() s·∫Ω xin quy·ªÅn micro khi listen()
        audioModel = await tmAudio.create(base + "model.json", base + "metadata.json");
        // ƒê·ªçc nh√£n l·ªõp ƒë·ªÉ hi·ªÉn th·ªã g·ª£i √Ω (n·∫øu c·∫ßn): audioModel.getClassLabels()
      }catch(e){
        console.error(e);
        toast("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c model √¢m thanh.");
      }
    }
    async function startAudioEmotion(){
      if(audioListening) return;
      if(!audioModel){
        await initAudioModel();
        if(!audioModel) return;
      }
      try{
        // L·∫Øng nghe t·ª´ mic v√† tr·∫£ v·ªÅ d·ª± ƒëo√°n li√™n t·ª•c
        await audioModel.listen(async (predictions) => {
          // predictions: [{className, probability}, ...]
          if(!predictions?.length) return;
          const best = predictions.reduce((a,b)=> a.probability>b.probability ? a : b);
          const label = (best.className || "").toString();
          const prob  = (best.probability*100).toFixed(1);

          // Chu·∫©n ho√° nh√£n v·ªÅ key
          const key = normalizeVoiceLabel(label);
          lastVoiceLabel = key;

          $("voiceEmotion").innerText = `${label} ${prob}%`;
          $("voicePitch").innerText   = ""; // Kh√¥ng d√πng f0 khi ƒë√£ c√≥ model √¢m thanh
          updateFinalEmotion();

        }, {
          includeSpectrogram: false,
          probabilityThreshold: 0.6,   // c√≥ th·ªÉ ch·ªânh cao/th·∫•p tu·ª≥ model
          overlapFactor: 0.5,          // 0.5 = 50% ch·ªìng l·∫•p, d·ª± ƒëo√°n m∆∞·ª£t h∆°n
        });
        audioListening = true;
        toast("üéôÔ∏è ƒêang nh·∫≠n di·ªán c·∫£m x√∫c qua gi·ªçng n√≥i...");
      }catch(e){
        console.error(e);
        toast("Kh√¥ng b·∫≠t ƒë∆∞·ª£c micro cho model √¢m thanh. Ki·ªÉm tra quy·ªÅn.");
      }
    }
    async function stopAudioEmotion(){
      try{
        await audioModel?.stopListening();
      }catch{}
      audioListening = false;
      $("voiceEmotion").innerText = "‚Äì";
      $("voicePitch").innerText   = "";
      lastVoiceLabel = "UNKNOWN";
    }
    function normalizeVoiceLabel(label){
      const up = (label || "").toUpperCase();
      if(up.includes("VUI") || up.includes("HAPPY") || up.includes("JOY")) return "HAPPY";
      if(up.includes("BU·ªíN") || up.includes("BUON") || up.includes("SAD") || up.includes("TR·∫¶M") || up.includes("TRAM")) return "SAD";
      if(up.includes("NEUTRAL") || up.includes("B√åNH") || up.includes("BINH")) return "NEUTRAL";
      return "UNKNOWN";
    }

    /* ================== FUSION: CAMERA + VOICE ================== */
    function getCameraKeyFromUI(){
      const txt = ($("emotion").innerText || "").toUpperCase();
      return normalizeLabelToKey(txt);
    }
    function updateFinalEmotion(){
      const cam = getCameraKeyFromUI();   // "HAPPY", "SAD", "ANGRY", "SURPRISED", "NEUTRAL", "UNKNOWN"
      const voc = lastVoiceLabel || "UNKNOWN";

      // Quy t·∫Øc g·ªôp:
      // 1) N·∫øu gi·ªçng n√≥i x√°c ƒë·ªãnh r√µ (HAPPY/SAD/NEUTRAL) ‚Üí ∆∞u ti√™n gi·ªçng n√≥i
      // 2) N·∫øu gi·ªçng n√≥i UNKNOWN ‚Üí d√πng camera
      // 3) N·∫øu m√¢u thu·∫´n m·∫°nh (v√≠ d·ª• cam ANGRY, voice HAPPY) ‚Üí v·∫´n ∆∞u ti√™n voice
      let finalKey = "NEUTRAL";
      if(voc !== "UNKNOWN") finalKey = voc;
      else if(cam !== "UNKNOWN") finalKey = cam;

      $("finalEmotion").innerText = finalKey;
    }

    /* ================== CHAT WITH GEMINI + STT (BROWSER) ================== */
    const chatBox = $("reply");
    const inputBox = $("userText");

    function appendMsg(role, text){
      const d = document.createElement("div");
      d.className = "msg";
      d.innerHTML = `<b>${role}:</b> ${text}`;
      chatBox.appendChild(d);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage(){
      if(ended){
        appendMsg("üê∂ PetBot","Phi√™n ƒë√£ k·∫øt th√∫c. B·∫•m K·∫øt th√∫c ‚Üí Kh√¥ng ƒë·ªÉ m·ªü phi√™n m·ªõi.");
        return;
      }
      const info = getUserInfoSession();
      if(!info){
        $("userInfoOverlay").style.display = "flex";
        alert("Vui l√≤ng nh·∫≠p H·ªç t√™n, L·ªõp, Tr∆∞·ªùng tr∆∞·ªõc khi tr√≤ chuy·ªán nh√©!");
        return;
      }
      const text = inputBox.value.trim();
      if(!text) return;

      appendMsg("B·∫°n", text);
      inputBox.value = "";
      $("chatBtn").disabled = true;
      chatBox.setAttribute('aria-busy','true');

      const camEmotion = $("finalEmotion").innerText || $("emotion").innerText || "‚Äì";
      const prompt = `B·∫°n l√† th√∫ c∆∞ng d·ªÖ th∆∞∆°ng (PetBot). Th√¥ng tin: T√™n ${info.name}, L·ªõp ${info.cls}, Tr∆∞·ªùng ${info.school}. C·∫£m x√∫c hi·ªán t·∫°i (g·ªôp): ${camEmotion}. H·ªçc sinh n√≥i: "${text}". Tr·∫£ l·ªùi ‚â§3 c√¢u, th√¢n thi·ªán.`;

      const ctrl = new AbortController();
      const timeoutId = setTimeout(()=>ctrl.abort(), 20000);

      try{
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
        const res = await fetch(url, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ contents:[{ parts:[{ text:prompt }]}] }),
          signal: ctrl.signal
        });
        const data = await res.json();
        const replyText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Xin l·ªói, m√¨nh ch∆∞a nghe r√µ. B·∫°n n√≥i l·∫°i nh√©?";
        appendMsg("üê∂ PetBot", replyText);

        // N√≥i l·∫°i b·∫±ng TTS c·ªßa tr√¨nh duy·ªát
        const u = new SpeechSynthesisUtterance(replyText);
        u.lang = "vi-VN";
        u.rate = 1.0;
        u.pitch = 1.0;
        window.speechSynthesis.speak(u);
      }catch(e){
        console.error(e);
        appendMsg("üê∂ PetBot","C√≥ l·ªói khi g·ªçi Gemini. Ki·ªÉm tra m·∫°ng/API key.");
      }finally{
        clearTimeout(timeoutId);
        $("chatBtn").disabled = false;
        chatBox.setAttribute('aria-busy','false');
      }
    }

    // Browser SpeechRecognition for text input by voice (n√∫t üé§ N√≥i)
    let rec = null, recActive = false;
    function initSTT(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){
        toast("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i (SpeechRecognition).");
        return null;
      }
      const r = new SR();
      r.lang = "vi-VN";
      r.interimResults = false;
      r.continuous = false;
      r.onstart = ()=>{ recActive=true; $("micBtn").textContent="üéôÔ∏è ƒêang nghe..."; };
      r.onend   = ()=>{ recActive=false; $("micBtn").textContent="üé§ N√≥i"; };
      r.onerror = (e)=>{ recActive=false; $("micBtn").textContent="üé§ N√≥i"; console.warn("STT error", e); toast("Kh√¥ng thu ƒë∆∞·ª£c ti·∫øng, th·ª≠ l·∫°i nh√©!"); };
      r.onresult = async (ev)=>{
        const text = ev.results?.[0]?.[0]?.transcript?.trim();
        if(text){
          inputBox.value = text;
          await sendMessage();
        }
      };
      return r;
    }

    /* ================== EXCEL REPORT ================== */
    function buildExcelBlob(info){
      const now = new Date();
      const rows = [
        ["B√ÅO C√ÅO T∆Ø V·∫§N T√ÇM L√ù"],
        [""],
        ["H·ªç v√† t√™n", info.name],
        ["L·ªõp", info.cls],
        ["Tr∆∞·ªùng", info.school],
        ["C·∫£m x√∫c camera", $("emotion").innerText || "‚Äì"],
        ["C·∫£m x√∫c gi·ªçng n√≥i", $("voiceEmotion").innerText || "‚Äì"],
        ["T·ªïng h·ª£p cu·ªëi", $("finalEmotion").innerText || "‚Äì"],
        ["Th·ªùi ƒëi·ªÉm", now.toLocaleString()],
      ];
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "BaoCao");
      const wbout = XLSX.write(wb, {bookType:"xlsx", type:"array"});
      return new Blob([wbout], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
    }
    async function trySendEmail(info){
      const blob = buildExcelBlob(info);
      try{
        const form = new FormData();
        form.append("name", info.name);
        form.append("cls", info.cls);
        form.append("school", info.school);
        form.append("emotion_camera", $("emotion").innerText || "‚Äì");
        form.append("emotion_voice", $("voiceEmotion").innerText || "‚Äì");
        form.append("emotion_final", $("finalEmotion").innerText || "‚Äì");
        form.append("file", new File([blob], "bao_cao_tam_ly.xlsx", {type: blob.type}));

        const res = await fetch(SEND_API_URL, { method:"POST", body: form });
        if(!res.ok) throw new Error(await res.text());
        toast("‚úÖ ƒê√£ g·ª≠i b√°o c√°o Excel ƒë·∫øn email c·ªßa chuy√™n gia.");
        appendMsg("üê∂ PetBot", "‚úÖ ƒê√£ g·ª≠i b√°o c√°o Excel ƒë·∫øn email c·ªßa chuy√™n gia. C·∫£m ∆°n b·∫°n!");
      }catch(err){
        console.warn("G·ª≠i email th·∫•t b·∫°i/kh√¥ng c√≥ server. T·∫£i file v·ªÅ m√°y.", err);
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "bao_cao_tam_ly.xlsx"; a.click();
        URL.revokeObjectURL(url);
        toast("‚ö†Ô∏è Kh√¥ng g·ª≠i ƒë∆∞·ª£c email. ƒê√£ t·∫£i file Excel v·ªÅ m√°y b·∫°n.");
        appendMsg("üê∂ PetBot", "‚ö†Ô∏è Kh√¥ng g·ª≠i ƒë∆∞·ª£c email (server ch∆∞a ch·∫°y/URL sai). M√¨nh ƒë√£ t·∫£i file Excel v·ªÅ m√°y b·∫°n.");
      }
    }

    /* ================== UI EVENTS ================== */
    $("chatBtn").addEventListener("click", sendMessage);
    $("clearBtn").addEventListener("click", ()=>{ $("reply").innerHTML=""; });
    $("userText").addEventListener("keydown", async (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); await sendMessage(); }});

    $("refreshBtn").addEventListener("click", async ()=>{
      try{ await ensureVideoPermissionOnce(); await listCameras(); }
      catch(e){ alert(e.message); }
    });
    $("camSelect").addEventListener("change", async ()=>{
      try{
        await startCam();
        $("startBtn").disabled = true;
        $("stopBtn").disabled  = false;
      }catch(e){ alert("Kh√¥ng b·∫≠t ƒë∆∞·ª£c camera: " + e.message); }
    });
    $("debugToggle").addEventListener("change", ()=>{
      const on = $("debugToggle").checked;
      $("rawVideoWrap").style.display = on ? "block" : "none";
      if(on && webcam?.webcam?.srcObject) $("rawVideo").srcObject = webcam.webcam.srcObject;
      else $("rawVideo").srcObject = null;
    });
    $("startBtn").addEventListener("click", async ()=>{
      try{
        if(!imageModel){ await initImageModel(); }
        await listCameras();
        await startCam();
        $("startBtn").disabled = true;
        $("stopBtn").disabled  = false;
      }catch(e){
        console.error(e);
        alert("Kh√¥ng b·∫≠t ƒë∆∞·ª£c camera: " + e.message);
      }
    });
    $("stopBtn").addEventListener("click", ()=>{ stopCam(); });

    $("micBtn").addEventListener("click", ()=>{
      const cfg = JSON.parse(localStorage.getItem("pet_settings") || "{}");
      if(cfg.mode!=="voice"){ toast("H√£y ch·ªçn ch·∫ø ƒë·ªô Gi·ªçng n√≥i + Khu√¥n m·∫∑t trong C√†i ƒë·∫∑t."); return; }
      if(!rec) rec = initSTT();
      if(!rec) return;
      if(recActive){ try{ rec.stop(); }catch{} return; }
      try{ rec.start(); }catch(e){ console.warn(e); }
    });

    $("openSettingsBtn").addEventListener("click", ()=>{
      const st = $("settingsOverlay");
      if(st) st.style.display = "flex";
    });

    // c·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc track ƒë·ªÉ con pet ƒëi qua l·∫°i ƒë√∫ng k√≠ch th∆∞·ªõc
    const trackEl = $("track");
    new ResizeObserver(()=>{
      document.documentElement.style.setProperty('--track-w', trackEl.clientWidth + 'px');
    }).observe(trackEl);

    // SETTINGS ‚Üí USER INFO
    window.addEventListener("DOMContentLoaded", ()=>{
      // m·ªü settings tr∆∞·ªõc
      const st = $("settingsOverlay");
      st.style.display = "flex";
      $("chatBtn").disabled = true;

      // n·∫øu ƒë√£ c√≥ c·∫•u h√¨nh
      try{
        const raw = localStorage.getItem("pet_settings");
        if(raw){
          const cfg = JSON.parse(raw);
          document.querySelectorAll('input[name="fontPick"]').forEach(r=>{ r.checked = (r.value === cfg.font); });
          document.querySelectorAll('input[name="bgPick"]').forEach(r=>{ r.checked = (r.value === cfg.bg); });
          document.querySelectorAll('input[name="modePick"]').forEach(r=>{ r.checked = (r.value === cfg.mode); });
          applyFont(cfg.font || "Poppins");
          applyBackground(cfg.bg || "aqua");
          setModeUI(cfg.mode || "voice");
        }
      }catch{}

      $("saveSettingsBtn").addEventListener("click", ()=>{
        const font = (document.querySelector('input[name="fontPick"]:checked')?.value) || "Poppins";
        const bg   = (document.querySelector('input[name="bgPick"]:checked')?.value) || "aqua";
        const mode = (document.querySelector('input[name="modePick"]:checked')?.value) || "voice";

        localStorage.setItem("pet_settings", JSON.stringify({font,bg,mode}));
        applyFont(font);
        applyBackground(bg);
        setModeUI(mode);

        // ƒë√≥ng settings, m·ªü user info
        st.style.display = "none";

        const overlay = $("userInfoOverlay");
        const saveBtn = $("saveInfoBtn");
        overlay.style.display = "flex";

        // prefill n·∫øu c√≥
        const nameInput = $("fullName");
        const clsInput  = $("className");
        const schInput  = $("schoolName");
        try{
          const raw = localStorage.getItem("userInfo");
          if(raw){
            const inf = JSON.parse(raw);
            nameInput.value = inf?.name || "";
            clsInput.value  = inf?.cls || "";
            schInput.value  = inf?.school || "";
          }
        }catch{}

        saveBtn.addEventListener("click", ()=>{
          const name = nameInput.value.trim();
          const cls  = clsInput.value.trim();
          const school = schInput.value.trim();
          if(!name || !cls || !school){
            alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç t√™n, l·ªõp v√† tr∆∞·ªùng!");
            return;
          }
          setUserInfoSession({name,cls,school});
          localStorage.setItem("userInfo", JSON.stringify({name,cls,school}));
          overlay.style.display = "none";
          $("chatBtn").disabled = false;
          appendMsg("üê∂ PetBot", `Xin ch√†o ${name} l·ªõp ${cls} ‚Äì ${school}! M√¨nh r·∫•t vui ƒë∆∞·ª£c tr√≤ chuy·ªán c√πng b·∫°n üíñ`);
        }, {once:true});
      }, {once:true});
    });

    // END SESSION
    $("endBtn").addEventListener("click", ()=>{ $("endConfirmOverlay").style.display="flex"; });
    $("endYesBtn").addEventListener("click", async ()=>{
      $("endConfirmOverlay").style.display="none";
      const info = getUserInfoSession();
      if(!info){
        appendMsg("üê∂ PetBot","Thi·∫øu th√¥ng tin ng∆∞·ªùi d√πng. Vui l√≤ng nh·∫≠p l·∫°i.");
        $("userInfoOverlay").style.display="flex";
        return;
      }
      ended = true;
      $("chatBtn").disabled = true;
      $("userText").disabled = true;
      appendMsg("üê∂ PetBot","M√¨nh s·∫Ω g·ª≠i b√°o c√°o Excel cho chuy√™n gia, ƒë·ª£i ch√∫t nh√©‚Ä¶");
      await trySendEmail(info);
    });
    $("endNoBtn").addEventListener("click", ()=>{
      $("endConfirmOverlay").style.display = "none";
      $("reply").innerHTML = "";
      ended = false;
      $("chatBtn").disabled = false;
      $("userText").disabled = false;
      appendMsg("üê∂ PetBot","ƒê√£ b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi. B·∫°n c·ª© nh·∫Øn ƒëi·ªÅu b·∫°n mu·ªën chia s·∫ª nh√©! üí¨");
      $("userText").focus();
    });
  </script>
</body>
</html>
